<!DOCTYPE html>
<html>
	<head>
		<title>ratty</title>
		<style>

			html, body{margin:0; padding:0; height:100%; font: 12px Arial, sans-serif;}
			#page{display:flex; flex-direction:column; /*padding:5px;*/ background:#333; height:100%; box-sizing:border-box;}
			
			#top{display:flex; flex-direction:row; /*padding:5px;*/ box-sizing:border-box;justify-content:flex-end;}
			#sessionlist{margin-right:auto; display:flex; flex-direction:row;}
			#controls{}
			
			button{font-size:12px; line-height:16px;}
			button.icon{font-size:16px}
			button.current{}
			button.current::before{content:"> ";} 
			
			#terminal{margin:0;padding:10px; font:14px monospace; background:black; color:#0f0; height:100%; box-sizing:border-box; overflow-y:auto; outline:0; white-space:pre;}
			#status{padding:5px; box-sizing:border-box; text-align:center; color:white;}

			#cursor{background:#0F0; color:black;}
			#cursor.error{background:#F00;}
			#terminal.active #cursor.blink{animation:blinker 500ms linear infinite;}
			@keyframes blinker{50% {opacity:0.3;}}

		</style>
		<link href="data:image/x-icon;base64,R0lGODlhEAAQAPEAAAAAAADmNgAAAAAAACH5BAlGAAIAIf8LTkVUU0NBUEUyLjADAQAAACwAAAAAEAAQAAAC5wQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAACAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAAAAQAAAAgUAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKAAAh+QQJRgACACwAAAAAEAAQAAAC5wQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAACAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKAAA7" rel="icon" type="image/x-icon" />
	</head>
	<body>

		<div id="page">
			<div id="top">
				<div id="sessionlist">
					<button class="icon" id="mainlog" title="Show logs">&equiv;</button>
					<button class="icon" id="restart" title="Restart">&#8634;</button>
					<button class="icon" id="clearhistory" title="Clear bash history">&#10060;</button>
					<div id="list"></div>
					<button class="icon" id="newsession" title="Create new session">&#10010;</button>
				</div>
				<div id="controls">
					<button class="icon" id="settings" title="Settings">&#9881;</button>
					<button class="icon" id="paste" title="Paste">&#9088;</button>
					<button class="icon" id="pop" title="Popout">&#10548;</button>
					<button class="icon" id="destroy" title="Kill tmux session">&#10060;</button>
				</div>
			</div>
			<div id="terminal" tabindex="1" autofocus></div>
			<div id="status">connecting...</div>
		</div>

		<script src="https://cdn.socket.io/socket.io-1.3.7.js"></script>
		<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>

		<script>

			var play_freq = function(freq, duration, delay){

				delay = delay || 0;

				// audio context
				var context = new window.AudioContext();
				var currTime = context.currentTime;
				var oscillator = context.createOscillator();
				var gainNode = context.createGain ? context.createGain() : context.createGainNode();
				oscillator.connect(gainNode);
				gainNode.connect(context.destination);

				// start and stop
				var start = currTime + delay;
				var finish = start + duration;
				var midpoint = start + (duration/2);
				oscillator.start ? oscillator.start(start) : oscillator.noteOn(start);
				oscillator.stop ? oscillator.stop(finish) : oscillator.noteOff(finish);

				//sine:0, square:1, sawtooth:2, triangle:3 
				oscillator.type = 1;
				oscillator.frequency.value = freq;

				//fade volume out (to zero) after midpoint - stops annoying clicking sound
				gainNode.gain.value = 0.2;
				gainNode.gain.linearRampToValueAtTime(0.2, midpoint);
				gainNode.gain.linearRampToValueAtTime(0, finish);
			};

			var beep = function(){
				play_freq(261.63, .2); //middle C
				play_freq(392.00, .1, .1); //middle G
				console.log("beep");
			};

			var keyCodeToKey = function(keyCode){
				var _keycode_dictionary = {

					0   : "\\",          // Firefox reports this keyCode when shift is held
					8   : "BSpace",
					9   : "Tab",
					12  : "num",
					13  : "enter",
					16  : "shift",
					17  : "ctrl",
					18  : "alt",
					19  : "pause",
					20  : "caps",
					27  : "esc",
					32  : "space",
					33  : "pageup",
					34  : "pagedown",
					35  : "end",
					36  : "home",
					37  : "left",
					38  : "up",
					39  : "right",
					40  : "down",
					44  : "print",
					45  : "insert",
					46  : "DC",			//delete
					48  : "0",
					49  : "1",
					50  : "2",
					51  : "3",
					52  : "4",
					53  : "5",
					54  : "6",
					55  : "7",
					56  : "8",
					57  : "9",
					65  : "a",
					66  : "b",
					67  : "c",
					68  : "d",
					69  : "e",
					70  : "f",
					71  : "g",
					72  : "h",
					73  : "i",
					74  : "j",
					75  : "k",
					76  : "l",
					77  : "m",
					78  : "n",
					79  : "o",
					80  : "p",
					81  : "q",
					82  : "r",
					83  : "s",
					84  : "t",
					85  : "u",
					86  : "v",
					87  : "w",
					88  : "x",
					89  : "y",
					90  : "z",
					91  : "cmd",
					92  : "cmd",
					93  : "cmd",
					96  : "num_0",
					97  : "num_1",
					98  : "num_2",
					99  : "num_3",
					100 : "num_4",
					101 : "num_5",
					102 : "num_6",
					103 : "num_7",
					104 : "num_8",
					105 : "num_9",
					106 : "num_multiply",
					107 : "num_add",
					108 : "num_enter",
					109 : "num_subtract",
					110 : "num_decimal",
					111 : "num_divide" ,
					112 : "f1",
					113 : "f2",
					114 : "f3",
					115 : "f4",
					116 : "f5",
					117 : "f6",
					118 : "f7",
					119 : "f8",
					120 : "f9",
					121 : "f10",
					122 : "f11",
					123 : "f12",
					124 : "print",
					144 : "num",
					145 : "scroll",
					186 : ";",
					187 : "=",
					188 : ",",
					189 : "-",
					190 : ".",
					191 : "/",
					192 : "`",
					219 : "[",
					220 : "\\",
					221 : "]",
					222 : "\'",
					223 : "`",
					224 : "cmd",
					225 : "alt",
					// Opera weirdness
					57392   : "ctrl",
					63289   : "num",
					// Firefox weirdness
					59 : ";",
					61 : "=",
					173 : "-"
				};
				return _keycode_dictionary[keyCode] || null;
			};


			$(function() {
				
				$("#terminal").focus(function(){$("#terminal").addClass('active');});
				$("#terminal").focusout(function(){$("#terminal").removeClass('active');});
				$(window).focus(function(){$("#terminal").focus();});
				$("body").click(function(){$("#terminal").focus();});

				var socket = io();

				$('#newsession').click(function(e){
					var newname = Math.random().toString(36).replace(/[^a-z]+/g, '').substr(0, 5);
					window.location.assign("?s="+newname);
				});

				$('#restart').click(function(e){
					socket.emit('keypress','sudo systemctl restart ratty');
				});

				$('#mainlog').click(function(e){
					socket.emit('keypress','systemctl status ratty -l');
				});

				$('#clearhistory').click(function(e){
					socket.emit('keypress','cat /dev/null > ~/.bash_history && history -c && exit');
				});

				$(document).on('click', '#sessionlist #list button', function(e){
					window.location.assign($(e.target).attr('href'));
				});



				$("body").keydown(function(e) {
					e.preventDefault();
					var key = keyCodeToKey(e.which);
					//console.log('keydown',key,e.ctrlKey);
					if(key!="ctrl" && key!="shift" && key!="alt" && key!="cmd"){
						if(e.shiftKey) key = key.toUpperCase();
						if(e.ctrlKey) key = 'C-'+key;
						socket.emit('keypress', key);
					}
				});
				
				/*
				$("body").keypress(function(e) {
					var code = e.charCode || e.keyCode;
					var key = String.fromCharCode(code);
					console.log('key',code,key,e.key,e);
					switch(key){
						case 'ArrowUp':		key="Up"; break;
						case 'ArrowDown':	key="Down"; break;
						case 'ArrowLeft':	key="Left"; break;
						case 'ArrowRight':	key="Right"; break;
						case 'Backspace':	key="BSpace"; break;
						case 'Delete':		key="DC"; break;
					}
					if(e.ctrlKey) key = 'C-'+key;
					socket.emit('keypress', key);
				});
				*/

				$('#destroy').click(function(e){
					if (confirm('Kill session '+window.location.search.replace('?s=','')+'?')) {
						socket.emit('destroy');
						$("#cursor").addClass('error');
					}
				});

				$('#paste').click(function(e){
					var cmd = prompt('paste command');
					if (cmd != null) {
						socket.emit('keypress',cmd);
					}
				});

				$('#pop').click(function(e){
					window.open('/'+window.location.search,'pop','height=250,width=450');
				});

				

					
				socket.on('sessionlist', function(list){
					var html = '';
					list.forEach(function(item) {
						var query = '?s=' + item;
						if(query === window.location.search){
							html += '<button class="current" href="'+query+'" title="Connect to session: '+item+'">'+item+'</button>';
						} else {
							html += '<button href="'+query+'" title="Connect to session: '+item+'">'+item+'</button>';
						}
					});
					$('#sessionlist #list').html(html);
				});

				socket.on('status', function(status){
					$('#status').text(status);
				});

				socket.on('disconnect', function(){
					$('#status').text('disconnected');
					$("#cursor").addClass('error');
				});

				socket.on('connect', function(){
					$("#cursor").removeClass('error');
				});

				var tty = '';
				var i = 0;
				var cursor_position = 0;

				socket.on('transcript', function(transcript){

					console.log(transcript);

					var insertAt = function(str1,str2,pos){
						return [str1.slice(0, pos), str2].join('');
					};

					//for(var i=0; i<transcript.length; i++){
					var i=0;
					while(i<transcript.length){
						
						switch(transcript.charAt(i)){
							
							default:
								tty = insertAt(tty, transcript.charAt(i), cursor_position);
								cursor_position++;
								i++;
							break;

							case "\r":
							case "\n":
								cursor_position=tty.length;
								tty = insertAt(tty, transcript.charAt(i), cursor_position);
								i++;
							break;

							case "":
								cursor_position--;
								i++;
							break;

							case "":
								if(i==transcript.length-1) beep();
								i++;
							break;

							case "":

								var nextchar1 = transcript.charAt(i+1);
								if(nextchar1 === "["){

									var nextchar2 = transcript.charAt(i+2);
									switch(nextchar2){

										// http://www.termsys.demon.co.uk/vtansi.htm

										//right
										case "C":
											cursor_position++;
											i++;	// c processed
										break;

										//clear screen
										case "H":
										case "J":
											cursor_position=0;
											i++;	// h or j processed
										break;

										// [K - clip to cursor?
										case "K":
											tty = insertAt(tty, '', cursor_position);
											i++;	// k procssed
										break;

										// [1P - delete (do not advance cursor)
										case "1":
											var nextchar3 = transcript.charAt(i+3);
											if(nextchar3 === "P") {
												i++;	// P processed
											}
											i++;	// 1 processed
										break;

										default:
											var nextm = transcript.substr(i+2).indexOf('m');
											var code = transcript.substr(i+2,nextm);
											var toinsert = '<span style="color:red;">{'+code+'}</span>';
											
											switch(code){
												case '0':
													var toinsert = '</span>';
												break;
												case '1;32':
													var toinsert = '<span style="color:red;">'; //not work
												break;
												case '01;34':
													var toinsert = '<span style="color:blue;">';
												break;
												case '01;36':
													var toinsert = '<span style="color:cyan;">';
												break;
												case '30;42':
													var toinsert = '<span style="color:black; background:green;">';
												break;
												case '40;33':
													var toinsert = '<span style="color:yellow;">';
												break;
												default:
													var toinsert = '<span style="color:black; background:red;">UNKNOWN ESCAPE CODE {'+code+'}</span>';
												break;


											}
											toinsert=toinsert+code;
											tty = insertAt(tty, toinsert, cursor_position);
											cursor_position+=toinsert.length;
											//cursor_position++;
											i+=code.length+1;
										break;

									}

									i++;	// [ processed

								}
								
								i++;	// esc processed
							break;
						}
					}

					var cursor_contains = tty.charAt(cursor_position);
					var out = [tty.slice(0, cursor_position), '<span id="cursor" class="blink">'+(cursor_contains?cursor_contains:'&nbsp;')+'</span>', tty.slice(cursor_position+1)].join('');

					$('#terminal').html(out);
					$("#terminal").scrollTop($("#terminal")[0].scrollHeight);

				});
			});

		</script>

	</body>
</html>
