<!DOCTYPE html>
<html>












	<head>






		<title>ratty v0.0.1</title>






		<style>

			html, body{margin:0; padding:0; height:100%; font: 12px Arial, sans-serif;}
			#page{display:flex; flex-direction:column; background:#333; height:100%; box-sizing:border-box;}
			
			#top{display:flex; flex-direction:row; box-sizing:border-box;justify-content:flex-end;}
			#sessionlist{margin-right:auto; display:flex; flex-direction:row;}
			#controls{}
			
			button{font-size:12px; line-height:16px;}
			button.icon{font-size:16px}
			button.current{}
			button.current::before{content:"> ";}

			#flexv100{height:100%; position:relative; margin:0 auto; width:960px;}
			.scrollcontainer{width:960px; height:100%; position:absolute;}
			#terminal{width:960px; padding:0px; font:14px monospace; background:#222; color:#0f0; box-sizing:border-box; /*overflow-y:auto;*/ outline:0; white-space:pre;}
			#terminal{background:center center no-repeat fixed url('data:image/png;base64,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');}

			.char{background:rgba(0,0,0,0.5); display:inline-block;}
			.char-style-1{font-weight:bold;}				/* Bright */
			.char-style-2{text-decoration:overline;}		/* Dim */
			.char-style-4{text-decoration:underline;}		/* Underscore */
			.char-style-5{}									/* Blink */
			.char-style-7{color:black; background:#0F0;}	/* Reverse (inverse colours?) */
			.char-style-8{text-decoration:line-through;}	/* Hidden */
			.char-style-30{color:black;}
			.char-style-31{color:red;}
			.char-style-32{color:green;}
			.char-style-33{color:yellow;}
			.char-style-34{color:blue;}
			.char-style-35{color:magenta;}
			.char-style-36{color:cyan;}
			.char-style-37{color:white;}
			.char-style-40{background:black;}
			.char-style-41{background:red;}
			.char-style-42{background:green;}
			.char-style-43{background:yellow;}
			.char-style-44{background:blue;}
			.char-style-45{background:magenta;}
			.char-style-46{background:cyan;}
			.char-style-47{background:white;}

			#status{padding:5px; box-sizing:border-box; text-align:center; color:white;}

			#top,#status{position:static;}

			#coords{display:block; position:absolute; color:yellow;}
			.cursor{background:#0F0; color:black;}
			.cursor.error{background:#F00;}

			#terminal.active .cursor,
			.char-style-5,
			.blink{animation:blinker 200ms ease infinite;}
			@keyframes blinker{
				50% {opacity:0.3;}
			}


			.char-64,
			.spin{animation:spinner 2000ms linear infinite;}
			@keyframes spinner{
				0% {transform:rotate(0deg);}
				100% {transform:rotate(360deg);}
			}

			.spinAway{animation:spinAway 500ms linear; opacity:0;}
			@keyframes spinAway{
				0% {transform:scale(1) rotate(0deg); opacity:1;}
				100% {transform:scale(0.1) rotate(360deg); opacity:0;}
			}

		</style>




		<link href="data:image/x-icon;base64,R0lGODlhEAAQAPEAAAAAAADmNgAAAAAAACH5BAlGAAIAIf8LTkVUU0NBUEUyLjADAQAAACwAAAAAEAAQAAAC5wQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAACAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAAAAQAAAAgUAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKAAAh+QQJRgACACwAAAAAEAAQAAAC5wQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAACAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKAAA7" rel="icon" type="image/x-icon" />




	</head>





























	<body>









		<div id="page">
			<div id="top">
				<div id="sessionlist">
					<div id="list"></div>
					<button class="icon" id="destroy" title="Kill tmux session">&#10060;</button>
					<button class="icon" id="newsession" title="Create new session">&#10010;</button>
				</div>
				<div id="controls">
					<!-- <button class="icon" id="showraw">R</button> -->
					<!-- <button class="icon" id="showhtml">H</button> -->
					<button class="icon" id="insert" title="Insert">&#10507;</button>
					<button class="icon" id="paste" title="Paste">&#9088;</button>
					<button class="icon" id="settings" title="Settings">&#9881;</button>
					<!-- <button class="icon" id="pop" title="Popout">&#10548;</button> -->
					<!-- <button class="icon" id="clearhistory" title="Clear bash history">&#10060;</button> -->
					<!-- <button class="icon" id="mainlog" title="Show logs">&equiv;</button> -->
					<!-- <button class="icon" id="restart" title="Restart">&#8634;</button> -->
				</div>
			</div>
			<div id="flexv100">
				<div id="scrollterminal" class="scrollcontainer" data-mcs-theme="dark">
					<div id="terminal" tabindex="1" autofocus></div>
				</div>
			</div>
			<div id="status"></div>
		</div>









		<script src="https://cdn.socket.io/socket.io-1.3.7.js"></script>
		<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>

		<script src="https://cdn.rawgit.com/malihu/malihu-custom-scrollbar-plugin/master/jquery.mCustomScrollbar.concat.min.js"></script>
		<link rel="stylesheet" type="text/css" href="https://cdn.rawgit.com/malihu/malihu-custom-scrollbar-plugin/master/jquery.mCustomScrollbar.min.css">

		<script>

			var play_freq = function(freq, duration, delay){

				delay = delay || 0;

				// audio context
				var context = new window.AudioContext();
				var currTime = context.currentTime;
				var oscillator = context.createOscillator();

				var gainNode = context.createGain ? context.createGain() : context.createGainNode();
				oscillator.connect(gainNode);
				gainNode.connect(context.destination);

				// convolver
				var convolver = context.createConvolver();
				oscillator.connect(convolver);

				// start and stop
				var start = currTime + delay;
				var finish = start + duration;
				var midpoint = start + (duration/2);
				oscillator.start ? oscillator.start(start) : oscillator.noteOn(start);
				oscillator.stop ? oscillator.stop(finish) : oscillator.noteOff(finish);

				//sine:0, square:1, sawtooth:2, triangle:3 
				oscillator.type = 1;
				oscillator.frequency.value = freq;

				//fade volume out (to zero) after midpoint - stops annoying clicking sound
				gainNode.gain.value = 0.2;
				gainNode.gain.linearRampToValueAtTime(0.2, midpoint);
				gainNode.gain.linearRampToValueAtTime(0, finish);
			};

			var beep = function(){
				play_freq(261.63, .2); //middle C
				play_freq(392.00, .1, .1); //middle G
			};
			beep();

			var keyCodeToKey = function(keyCode){
				var _keycode_dictionary = {

					0   : "\\",          // Firefox reports this keyCode when shift is held
					8   : "BSpace",
					9   : "Tab",
					12  : "num",
					13  : "enter",
					16  : "shift",
					17  : "ctrl",
					18  : "alt",
					19  : "pause",
					20  : "caps",
					27  : "esc",
					32  : "space",
					33  : "pageup",
					34  : "pagedown",
					35  : "end",
					36  : "home",
					37  : "left",
					38  : "up",
					39  : "right",
					40  : "down",
					44  : "print",
					45  : "insert",
					46  : "DC",			//delete
					48  : "0",
					49  : "1",
					50  : "2",
					51  : "3",
					52  : "4",
					53  : "5",
					54  : "6",
					55  : "7",
					56  : "8",
					57  : "9",
					65  : "a",
					66  : "b",
					67  : "c",
					68  : "d",
					69  : "e",
					70  : "f",
					71  : "g",
					72  : "h",
					73  : "i",
					74  : "j",
					75  : "k",
					76  : "l",
					77  : "m",
					78  : "n",
					79  : "o",
					80  : "p",
					81  : "q",
					82  : "r",
					83  : "s",
					84  : "t",
					85  : "u",
					86  : "v",
					87  : "w",
					88  : "x",
					89  : "y",
					90  : "z",
					91  : "cmd",
					92  : "cmd",
					93  : "cmd",
					96  : "num_0",
					97  : "num_1",
					98  : "num_2",
					99  : "num_3",
					100 : "num_4",
					101 : "num_5",
					102 : "num_6",
					103 : "num_7",
					104 : "num_8",
					105 : "num_9",
					106 : "num_multiply",
					107 : "num_add",
					108 : "num_enter",
					109 : "num_subtract",
					110 : "num_decimal",
					111 : "num_divide" ,
					112 : "f1",
					113 : "f2",
					114 : "f3",
					115 : "f4",
					116 : "f5",
					117 : "f6",
					118 : "f7",
					119 : "f8",
					120 : "f9",
					121 : "f10",
					122 : "f11",
					123 : "f12",
					124 : "print",
					144 : "num",
					145 : "scroll",
					186 : ";",
					187 : "=",
					188 : ",",
					189 : "-",
					190 : ".",
					191 : "/",
					192 : "`",
					219 : "[",
					220 : "\\",
					221 : "]",
					222 : "\'",
					223 : "`",
					224 : "cmd",
					225 : "alt",
					// Opera weirdness
					57392   : "ctrl",
					63289   : "num",
					// Firefox weirdness
					59 : ";",
					61 : "=",
					173 : "-"
				};
				return _keycode_dictionary[keyCode] || null;
			};


			var tty = {

				raw:{
					lines:[[]],
					cursor:{
						line:0,
						column:0
					},
					dimensions:{
						width:120,
						height:50
					},
					inkwith:''
				},

				showOutput:function(){

					console.log('rawlines:',this.raw.lines,'cursor:',this.raw.cursor);
						
					var source = []; for(var i=0; i<this.raw.lines.length; i++) {
						//console.log(i+' of '+this.raw.lines.length,this.raw.lines[i]);
						source.push(this.raw.lines[i].slice());}	//slice to copy array

					if(source[this.raw.cursor.line][this.raw.cursor.column]===undefined){source[this.raw.cursor.line][this.raw.cursor.column]={char:' '};}


					//var out = '<span id="coords">('+this.raw.cursor.column+','+this.raw.cursor.line+')</span>'+"\n";
					var out = '';
					for(var i=0;i<source.length;i++){
						for(var j=0;j<source[i].length;j++){
							//console.log(i,j);
							out += '<span class="';
							out += 'char ';
							out += 'char-'+source[i][j].char.charCodeAt(0)+' ';
							out += source[i][j].inkwith+' ';
							if(i===this.raw.cursor.line && j===this.raw.cursor.column) out += 'cursor ';
							out += '">'+source[i][j].char+'</span>';
						}
						out += '\n';
					}

					$('#terminal').html(out);
				},

				insertChar: function(c){

					if(this.raw.lines[this.raw.cursor.line]===undefined) this.raw.lines[this.raw.cursor.line]=[[]];
					this.raw.lines[this.raw.cursor.line][this.raw.cursor.column] = {char:c, inkwith:this.raw.inkwith};

				},

				erase: function(){
					this.raw.lines[this.raw.cursor.line] = this.raw.lines[this.raw.cursor.line].slice(0,this.raw.cursor.column);
				},

				//parse ansi one char at a time into array of lines, takes a multi character string of ansi
				addAnsi:function(ansi_blob){

					console.log(ansi_blob);

					// for each character in blob
					for(var ansi_char_index=0; ansi_char_index<ansi_blob.length; ansi_char_index++){

						var ansi_char = ansi_blob.charAt(ansi_char_index);
						switch(ansi_char){
							
							default:
								console.log('inserting "'+ansi_char+'" ('+ansi_char.charCodeAt(0)+') at ('+this.raw.cursor.column+','+this.raw.cursor.line+')');
								if(this.raw.cursor.column===this.raw.dimensions.width){
									this.raw.cursor.column=0;
									this.raw.cursor.line++;
									console.log(' >>> out-of-bounds, inserting at ('+this.raw.cursor.column+','+this.raw.cursor.line+') instead');
								}
								this.insertChar(ansi_char);
								this.raw.cursor.column++;
							break;
							
							case "": //Shift In, resume defaultn character set 
								//console.log("shift in (ignored)");
								//this.insertChar('');
								//this.raw.cursor.column++;
							break;

							case "\n":
								//console.log("newline n");
								this.raw.cursor.line++;
								this.raw.lines[this.raw.cursor.line]=[{char:''}];
							break;

							case "\r":
								//console.log("carrage return");
								this.raw.cursor.column=0;
							break;
							
							case "":
								//console.log("backspace");
								this.raw.cursor.column--;
							break;
							
							case "":
								//console.log("bell");
								if(ansi_char_index==ansi_blob.length-1) beep();
							break;
							
							case "":

								var nextalphaindex = ansi_blob.substr(ansi_char_index).search(/[a-z@=()]/i);
								var code = ansi_blob.substr(ansi_char_index, nextalphaindex+1);
								
								if(ansi_blob.charAt(ansi_char_index+1)==="["){
									var arguments = ansi_blob.substr(ansi_char_index+2, nextalphaindex-2).split(';');
								}
								//console.log("ESC: "+code);

								switch(code[nextalphaindex]){

									//other
									default:
									case "h":
									case "l":
									case "=":
									case "(":
									case ")":
										console.log('UNKNOWN: '+code);
									break;


									//shift line right?
									case "@":
										this.raw.lines[this.raw.cursor.line].unshift(' ');
										this.raw.lines[this.raw.cursor.line][0]=this.raw.lines[this.raw.cursor.line][1];
									break;

									//scroll up?
									case "M":
										this.raw.cursor.line--;
										//this.raw.cursor.column=0;
									break;

									// <ESC>[{ROW};{COLUMN}H
									// Cursor Home
									// Sets the cursor position where subsequent text will begin.
									// If no row/column parameters are provided (ie. <ESC>[H),
									// the cursor will move to the home position, at the upper left of the screen.
									case "H":
										console.log('cursor home',arguments);
										var row = arguments[0];
										var column = arguments[1];
										this.cursor_position=0;
									break;

									case "r":
										console.log('UNKNOWN r: '+code,arguments);
										var rows = arguments[1];
										for(var i=0; i<rows; i++){
											console.log('case r:',this.raw.lines[i]);
											if(this.raw.lines[i]===undefined) this.raw.lines[i]=[{char:'r'}];
										}
										console.log('case r finished:',this.raw.lines);
									break;
									


									// <ESC>[{COUNT}A
									// Cursor Up
									// Moves the cursor up by COUNT rows; the default count is 1.
									case "A":
										console.log("escape code A");

									break;

									case "B":
										console.log("escape code B");

									break;

									// <ESC>[{COUNT}C
									// Cursor Forward
									// Moves the cursor forward by COUNT columns; the default count is 1.
									case "C":
										this.raw.cursor.column++;
										//this.adjustCursor();
									break;

									case "D":
										console.log("escape code D");
									break;




									// Delete
									// Set Key Definition
									// dont advance cursor by COUNT?
									//	this.insertAndClip('');
									//break;

									// Erase
									// <ESC>[J - Erase Down, Erases the screen from the current line down to the bottom of the screen. 
									// <ESC>[1J - Erase Up, Erases the screen from the current line up to the top of the screen. 
									// <ESC>[2J - Erase Screen, Erases the screen with the background colour and moves the cursor to home.
									case "J":
										this.raw.lines = [];
										this.raw.cursor.line=0;
										this.raw.cursor.column=0;
									break;

									// Erase Line
									// <ESC>[K - Erase End of Line, Erases from the current cursor position to the end of the current line.
									// <ESC>[1K - Erase Start of Line, Erases from the current cursor position to the start of the current line.
									// <ESC>[2K - Erase Line, Erases the entire current line. 
									case "P":
									case "K":
										var count = arguments[0];
										this.erase();
									break;

									//color codes
									case "m":
										console.log('color code:'+code,arguments,parseInt(arguments[0]),parseInt(arguments[1]));
										for(var j=0;j<arguments.length;j++){
											if(parseInt(arguments[j])>=1) this.raw.inkwith+='char-style-'+parseInt(arguments[j])+' ';
											else this.raw.inkwith = '';
										}
									break;

								}
								ansi_char_index+=nextalphaindex;	// move past current escape code

							break;


						} // end switch

					} // end for loop

					this.showOutput();

				}
			};
























			$(function() {
				
				$("#terminal").focus(function(){$("#terminal").addClass('active');});
				$("#terminal").focusout(function(){$("#terminal").removeClass('active');});
				$(".scrollcontainer").mCustomScrollbar({scrollInertia:0,scrollbarPosition:"outside"});
				$(window).focus(function(){$("#terminal").focus();});
				$("body").click(function(){$("#terminal").focus();});

				var socket = io();

				$('#newsession').click(function(e){
					var newname = Math.random().toString(36).replace(/[^a-z]+/g, '').substr(0, 5);
					window.location.assign("?s="+newname);
				});


				$(document).on('click', '#sessionlist #list button', function(e){
					window.location.assign($(e.target).attr('href'));
				});



				$("body").keydown(function(e) {
					e.preventDefault();
					var key = keyCodeToKey(e.which);
					if(key!="ctrl" && key!="shift" && key!="alt" && key!="cmd"){
						if(e.shiftKey) key = key.toUpperCase();
						if(e.ctrlKey) key = 'C-'+key;
						socket.emit('keypress', key);
					}
				});

				$('#destroy').click(function(e){
					if (confirm('Kill session '+window.location.search.replace('?s=','')+'?')) {
						socket.emit('destroy');
						$("#cursor").addClass('error');
					}
				});





/*


				$('#showraw').click(function(e){
					//tty.showOutput();

					$('#terminal span').each(function(i){
						$(this).delay(i*10).queue(function(){
							$(this).removeClass('spinAway').addClass('spinAway').dequeue();
						});
					});

				});
*/
/*
				$('#showhtml').click(function(e){
					$('#terminal').text(tty.html.lines.join('\n'));
				});

*/







				$('#paste').click(function(e){
					var cmd = prompt('paste command');
					if(cmd != null) {
						socket.emit('keypress',cmd);
					}
				});


				$('#insert').click(function(e){
					var options = [
						'sudo systemctl restart ratty',
						'systemctl status ratty -l',
						'cat /dev/null > ~/.bash_history && history -c && exit',
						'sudo init 6'
					];
					var optionsmsg = '';
					for(var i=0; i<options.length; i++) optionsmsg += i+': '+options[i]+'\n';
					var cmd = prompt('Insert command by number\n\n'+optionsmsg);
					socket.emit('keypress',options[cmd]);
					
				});




				$('#restart').click(function(e){
					socket.emit('keypress','sudo systemctl restart ratty');
				});

				$('#mainlog').click(function(e){
					socket.emit('keypress','systemctl status ratty -l');
				});

				$('#clearhistory').click(function(e){
					socket.emit('keypress','cat /dev/null > ~/.bash_history && history -c && exit');
				});






				/*

				$('#pop').click(function(e){
					window.open('/'+window.location.search,'pop','height=400,width=1000');
				});

				*/

				

					
				socket.on('sessionlist', function(list){
					var html = '';
					list.forEach(function(item) {
						var query = '?s=' + item;
						if(query === window.location.search){
							html += '<button class="current" href="'+query+'" title="Connect to session: '+item+'">'+item+'</button>';
						} else {
							html += '<button href="'+query+'" title="Connect to session: '+item+'">'+item+'</button>';
						}
					});
					$('#sessionlist #list').html(html);
				});

				socket.on('status', function(status){
					$('#status').text(status);
				});

				socket.on('disconnect', function(){
					$('#status').text('disconnected');
					$("#cursor").addClass('error');
				});

				socket.on('connect', function(){
					$("#cursor").removeClass('error');
				});



				socket.on('transcript', function(transcript){

					//console.log(transcript, typeof transcript, transcript.length, transcript.charCodeAt(0));
					tty.addAnsi(transcript);

					//var cursor_contains = tty.html.charAt(tty.cursor_position);
					//var out = [tty.html.slice(0, tty.cursor_position), '<span id="cursor" class="blink" debug-pos="'+tty.cursor_position+'">'+(cursor_contains?cursor_contains:'&nbsp;')+'</span>', tty.html.slice(tty.cursor_position+1)].join('');

					//$('#terminal').html(out);
					$("#terminal").scrollTop($("#terminal")[0].scrollHeight);
					$(".scrollcontainer").mCustomScrollbar("scrollTo","bottom");

				});
			});

		</script>

	</body>
</html>
