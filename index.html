<!DOCTYPE html>
<html>
	<head>
		<title>ratty</title>
		<style>

			html, body{margin:0; padding:0; height:100%; font: 12px Arial, sans-serif;}
			#page{display:flex; flex-direction:column; /*padding:5px;*/ background:#333; height:100%; box-sizing:border-box;}
			
			#top{display:flex; flex-direction:row; /*padding:5px;*/ box-sizing:border-box;justify-content:flex-end;}
			#sessionlist{margin-right:auto; display:flex; flex-direction:row;}
			#controls{}
			
			button{font-size:12px; line-height:16px;}
			button.icon{font-size:16px}
			button.current{}
			button.current::before{content:"> ";} 
			
			#terminal{margin:0;padding:10px; font:14px monospace; background:black; color:#0f0; height:100%; box-sizing:border-box; overflow-y:auto; outline:0; white-space:pre;}
			#status{padding:5px; box-sizing:border-box; text-align:center; color:white;}

			#cursor{background:#0F0; color:black;}
			#cursor.error{background:#F00;}
			#terminal.active #cursor.blink{animation:blinker 500ms linear infinite;}
			@keyframes blinker{50% {opacity:0.3;}}

		</style>
		<link href="data:image/x-icon;base64,R0lGODlhEAAQAPEAAAAAAADmNgAAAAAAACH5BAlGAAIAIf8LTkVUU0NBUEUyLjADAQAAACwAAAAAEAAQAAAC5wQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAACAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAAAAQAAAAgUAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKAAAh+QQJRgACACwAAAAAEAAQAAAC5wQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAACAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKAAA7" rel="icon" type="image/x-icon" />
	</head>
	<body>

		<div id="page">
			<div id="top">
				<div id="sessionlist">
					<button class="icon" id="mainlog" title="Show logs">&equiv;</button>
					<button class="icon" id="restart" title="Restart">&#8634;</button>
					<div id="list"></div>
					<button class="icon" id="newsession" title="Create new session">&#10010;</button>
				</div>
				<div id="controls">
					<button class="icon" id="settings" title="Settings">&#9881;</button>
					<button class="icon" id="paste" title="Paste">&#9088;</button>
					<button class="icon" id="pop" title="Popout">&#10548;</button>
					<button class="icon" id="destroy" title="Kill tmux session">&#10060;</button>
				</div>
			</div>
			<div id="terminal" tabindex="1" autofocus></div>
			<div id="status">connecting...</div>
		</div>

		<script src="https://cdn.socket.io/socket.io-1.3.7.js"></script>
		<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>

		<script>

			var play_freq = function(freq, duration, delay=0){

				// audio context
				var context = new window.AudioContext();
				var currTime = context.currentTime;
				var oscillator = context.createOscillator();
				var gainNode = context.createGain ? context.createGain() : context.createGainNode();
				oscillator.connect(gainNode);
				gainNode.connect(context.destination);

				// start and stop
				var start = currTime + delay;
				var finish = start + duration;
				var midpoint = start + (duration/2);
				oscillator.start ? oscillator.start(start) : oscillator.noteOn(start);
				oscillator.stop ? oscillator.stop(finish) : oscillator.noteOff(finish);

				//sine:0, square:1, sawtooth:2, triangle:3 
				oscillator.type = 1;
				oscillator.frequency.value = freq;

				//fade volume out (to zero) after midpoint - stops annoying clicking sound
				gainNode.gain.value = 0.2;
				gainNode.gain.linearRampToValueAtTime(0.2, midpoint);
				gainNode.gain.linearRampToValueAtTime(0, finish);
			};

			var beep = function(){
				play_freq(261.63, .2); //middle C
				play_freq(392.00, .1, .1); //middle G
				console.log("beep");
			};

			$(function() {
				
				$("#terminal").focus(function(){$("#terminal").addClass('active');});
				$("#terminal").focusout(function(){$("#terminal").removeClass('active');});
				$(window).focus(function(){$("#terminal").focus();});
				$("body").click(function(){$("#terminal").focus();});

				var socket = io();

				$('#newsession').click(function(e){
					var newname = Math.random().toString(36).replace(/[^a-z]+/g, '').substr(0, 5);
					window.location.assign("?s="+newname);
				});

				$('#restart').click(function(e){
					socket.emit('keypress','sudo systemctl restart ratty');
				});

				$('#mainlog').click(function(e){
					socket.emit('keypress','systemctl status ratty -l');
				});

				$(document).on('click', '#sessionlist #list button', function(e){
					window.location.assign($(e.target).attr('href'));
				});

				$("body").keypress(function(e) {
					e.preventDefault();
					var key = e.key;
					switch(e.key){
						case 'ArrowUp':		key="Up"; break;
						case 'ArrowDown':	key="Down"; break;
						case 'ArrowLeft':	key="Left"; break;
						case 'ArrowRight':	key="Right"; break;
						case 'Backspace':	key="BSpace"; break;
						case 'Delete':		key="DC"; break;
					}
					if(e.ctrlKey) key = 'C-'+key;
					socket.emit('keypress', key);
				});

				$('#destroy').click(function(e){
					if (confirm('Kill session '+window.location.search.replace('?s=','')+'?')) {
						socket.emit('destroy');
						$("#cursor").addClass('error');
					}
				});

				$('#paste').click(function(e){
					var cmd = prompt('paste command');
					if (cmd != null) {
						socket.emit('keypress',cmd);
					}
				});

				$('#pop').click(function(e){
					window.open('/'+window.location.search,'pop','height=250,width=450');
				});

				

					
				socket.on('sessionlist', function(list){
					var html = '';
					list.forEach(function(item) {
						var query = '?s=' + item;
						if(query === window.location.search){
							html += '<button class="current" href="'+query+'" title="Connect to session: '+item+'">'+item+'</button>';
						} else {
							html += '<button href="'+query+'" title="Connect to session: '+item+'">'+item+'</button>';
						}
					});
					$('#sessionlist #list').html(html);
				});

				socket.on('status', function(status){
					$('#status').text(status);
				});

				socket.on('disconnect', function(){
					$('#status').text('disconnected');
					$("#cursor").addClass('error');
				});

				socket.on('connect', function(){
					$("#cursor").removeClass('error');
				});

				var tty = '';
				var i = 0;
				var cursor_position = 0;

				socket.on('transcript', function(transcript){

					console.log(transcript);

					var insertAt = function(str1,str2,pos){
						return [str1.slice(0, pos), str2].join('');
					};

					//for(var i=0; i<transcript.length; i++){
					var i=0;
					while(i<transcript.length){
						
						switch(transcript.charAt(i)){
							
							default:
								tty = insertAt(tty, transcript.charAt(i), cursor_position);
								cursor_position++;
								i++;
							break;

							case "\r":
							case "\n":
								cursor_position=tty.length;
								tty = insertAt(tty, transcript.charAt(i), cursor_position);
								i++;
							break;

							case "":
								cursor_position--;
								i++;
							break;

							case "":
								if(i==transcript.length-1) beep();
								i++;
							break;

							case "":

								var nextchar1 = transcript.charAt(i+1);
								if(nextchar1 === "["){

									var nextchar2 = transcript.charAt(i+2);
									switch(nextchar2){

										//right
										case "C":
											cursor_position++;
											//i=i+2;
											i++;	// c processed
										break;

										//clear screen
										case "H":
										case "J":
											cursor_position=0;
											//i=i+2;
											i++;	// h or j processed
										break;

										// [K - clip to cursor?
										case "K":
											tty = insertAt(tty, '', cursor_position);
											//i=i+2;
											i++;	// k procssed
										break;

										// [1P - delete (do not advance cursor)
										case "1":
											var nextchar3 = transcript.charAt(i+3);
											if(nextchar3 === "P") {
												i++;	// P processed
											}
											i++;	// 1 processed
										break;

										default:
											var nextm = transcript.substr(i+2).indexOf('m');
											var code = transcript.substr(i+2,nextm);
											var toinsert = '<span style="color:red;">{'+code+'}</span>';
											
											switch(code){
												case '0':
													var toinsert = '</span>';
												break;
												case '1;32':
													var toinsert = '<span style="color:red;">';
												break;
												case '01;34':
													var toinsert = '<span style="color:blue;">';
												break;
												case '01;36':
													var toinsert = '<span style="color:cyan;">';
												break;
												case '30;42':
													var toinsert = '<span style="color:black; background:green;">';
												break;
												case '40;33':
													var toinsert = '<span style="color:yellow;">';
												break;
												default:
													var toinsert = '<span style="color:black; background:red;">UNKNOWN ESCAPE CODE</span>';
												break;


											}
											tty = insertAt(tty, toinsert, cursor_position);
											cursor_position+=toinsert.length;
											//cursor_position++;
											i+=code.length+1;
										break;

									}

									i++;	// [ processed

								}
								
								i++;	// esc processed
							break;
						}
					}

					var cursor_contains = tty.charAt(cursor_position);
					var out = [tty.slice(0, cursor_position), '<span id="cursor" class="blink">'+(cursor_contains?cursor_contains:'&nbsp;')+'</span>', tty.slice(cursor_position+1)].join('');

					$('#terminal').html(out);
					$("#terminal").scrollTop($("#terminal")[0].scrollHeight);

				});
			});

		</script>

	</body>
</html>
