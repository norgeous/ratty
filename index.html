<!DOCTYPE html>
<html>












	<head>






		<title>ratty</title>






		<style>

			html, body{margin:0; padding:0; height:100%; font: 12px Arial, sans-serif;}
			#page{display:flex; flex-direction:column; /*padding:5px;*/ background:#333; height:100%; box-sizing:border-box;}
			
			#top{display:flex; flex-direction:row; /*padding:5px;*/ box-sizing:border-box;justify-content:flex-end;}
			#sessionlist{margin-right:auto; display:flex; flex-direction:row;}
			#controls{}
			
			button{font-size:12px; line-height:16px;}
			button.icon{font-size:16px}
			button.current{}
			button.current::before{content:"> ";}

			#flexv100{height:100%; position:relative; margin:0 auto; width:960px;}
			.scrollcontainer{width:960px; height:100%; position:absolute;}
			#terminal{width:960px; padding:0px; font:14px monospace; background:#222; color:#0f0; box-sizing:border-box; /*overflow-y:auto;*/ outline:0; white-space:pre;}
			
			.char-style-1{font-weight:bold;}				/* Bright */
			.char-style-2{text-decoration:overline;}		/* Dim */
			.char-style-4{text-decoration:underline;}		/* Underscore */
			.char-style-5{}									/* Blink */
			.char-style-7{color:black; background:#0F0;}	/* Reverse (inverse colours?) */
			.char-style-8{text-decoration:line-through;}	/* Hidden */
			.char-style-30{color:Black;}
			.char-style-31{color:Red;}
			.char-style-32{color:Green;}
			.char-style-33{color:Yellow;}
			.char-style-34{color:Blue;}
			.char-style-35{color:Magenta;}
			.char-style-36{color:Cyan;}
			.char-style-37{color:White;}
			.char-style-40{background:Black;}
			.char-style-41{background:Red;}
			.char-style-42{background:Green;}
			.char-style-43{background:Yellow;}
			.char-style-44{background:Blue;}
			.char-style-45{background:Magenta;}
			.char-style-46{background:Cyan;}
			.char-style-47{background:White;}

			#status{padding:5px; box-sizing:border-box; text-align:center; color:white;}

			#top,#status{position:static;}

			#coords{display:block; position:absolute; color:yellow;}
			.char{background:black; display:inline-block;}
			.cursor{background:#0F0; color:black;}
			.cursor.error{background:#F00;}

			#terminal.active .cursor,
			.char-style-5,
			.blink{animation:blinker 200ms ease infinite;}
			@keyframes blinker{
				50% {opacity:0.3;}
			}


			.char-64,
			.spin{animation:spinner 2000ms linear infinite;}
			@keyframes spinner{
				0% {transform:rotate(0deg);}
				100% {transform:rotate(360deg);}
			}

			.spinAway{animation:spinAway 500ms linear; opacity:0;}
			@keyframes spinAway{
				0% {transform:scale(1) rotate(0deg); opacity:1;}
				100% {transform:scale(0.1) rotate(360deg); opacity:0;}
			}

		</style>




		<link href="data:image/x-icon;base64,R0lGODlhEAAQAPEAAAAAAADmNgAAAAAAACH5BAlGAAIAIf8LTkVUU0NBUEUyLjADAQAAACwAAAAAEAAQAAAC5wQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAACAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAAAAQAAAAgUAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKAAAh+QQJRgACACwAAAAAEAAQAAAC5wQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAACAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKAAA7" rel="icon" type="image/x-icon" />




	</head>





























	<body>









		<div id="page">
			<div id="top">
				<div id="sessionlist">
					<div id="list"></div>
					<button class="icon" id="destroy" title="Kill tmux session">&#10060;</button>
					<button class="icon" id="newsession" title="Create new session">&#10010;</button>
				</div>
				<div id="controls">
					<!-- <button class="icon" id="showraw">R</button> -->
					<!-- <button class="icon" id="showhtml">H</button> -->
					<button class="icon" id="insert" title="Insert">&#10507;</button>
					<button class="icon" id="paste" title="Paste">&#9088;</button>
					<button class="icon" id="settings" title="Settings">&#9881;</button>
					<!-- <button class="icon" id="pop" title="Popout">&#10548;</button> -->
					<!-- <button class="icon" id="clearhistory" title="Clear bash history">&#10060;</button> -->
					<!-- <button class="icon" id="mainlog" title="Show logs">&equiv;</button> -->
					<!-- <button class="icon" id="restart" title="Restart">&#8634;</button> -->
				</div>
			</div>
			<div id="flexv100">
				<div id="scrollterminal" class="scrollcontainer" data-mcs-theme="dark">
					<div id="terminal" tabindex="1" autofocus></div>
				</div>
			</div>
			<div id="status"></div>
		</div>









		<script src="https://cdn.socket.io/socket.io-1.3.7.js"></script>
		<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>

		<script src="https://cdn.rawgit.com/malihu/malihu-custom-scrollbar-plugin/master/jquery.mCustomScrollbar.concat.min.js"></script>
		<link rel="stylesheet" type="text/css" href="https://cdn.rawgit.com/malihu/malihu-custom-scrollbar-plugin/master/jquery.mCustomScrollbar.min.css">

		<script>

			var play_freq = function(freq, duration, delay){

				delay = delay || 0;

				// audio context
				var context = new window.AudioContext();
				var currTime = context.currentTime;
				var oscillator = context.createOscillator();

				var gainNode = context.createGain ? context.createGain() : context.createGainNode();
				oscillator.connect(gainNode);
				gainNode.connect(context.destination);

				// convolver
				var convolver = context.createConvolver();
				oscillator.connect(convolver);

				// start and stop
				var start = currTime + delay;
				var finish = start + duration;
				var midpoint = start + (duration/2);
				oscillator.start ? oscillator.start(start) : oscillator.noteOn(start);
				oscillator.stop ? oscillator.stop(finish) : oscillator.noteOff(finish);

				//sine:0, square:1, sawtooth:2, triangle:3 
				oscillator.type = 1;
				oscillator.frequency.value = freq;

				//fade volume out (to zero) after midpoint - stops annoying clicking sound
				gainNode.gain.value = 0.2;
				gainNode.gain.linearRampToValueAtTime(0.2, midpoint);
				gainNode.gain.linearRampToValueAtTime(0, finish);
			};

			var beep = function(){
				play_freq(261.63, .2); //middle C
				play_freq(392.00, .1, .1); //middle G
			};
			beep();

			var keyCodeToKey = function(keyCode){
				var _keycode_dictionary = {

					0   : "\\",          // Firefox reports this keyCode when shift is held
					8   : "BSpace",
					9   : "Tab",
					12  : "num",
					13  : "enter",
					16  : "shift",
					17  : "ctrl",
					18  : "alt",
					19  : "pause",
					20  : "caps",
					27  : "esc",
					32  : "space",
					33  : "pageup",
					34  : "pagedown",
					35  : "end",
					36  : "home",
					37  : "left",
					38  : "up",
					39  : "right",
					40  : "down",
					44  : "print",
					45  : "insert",
					46  : "DC",			//delete
					48  : "0",
					49  : "1",
					50  : "2",
					51  : "3",
					52  : "4",
					53  : "5",
					54  : "6",
					55  : "7",
					56  : "8",
					57  : "9",
					65  : "a",
					66  : "b",
					67  : "c",
					68  : "d",
					69  : "e",
					70  : "f",
					71  : "g",
					72  : "h",
					73  : "i",
					74  : "j",
					75  : "k",
					76  : "l",
					77  : "m",
					78  : "n",
					79  : "o",
					80  : "p",
					81  : "q",
					82  : "r",
					83  : "s",
					84  : "t",
					85  : "u",
					86  : "v",
					87  : "w",
					88  : "x",
					89  : "y",
					90  : "z",
					91  : "cmd",
					92  : "cmd",
					93  : "cmd",
					96  : "num_0",
					97  : "num_1",
					98  : "num_2",
					99  : "num_3",
					100 : "num_4",
					101 : "num_5",
					102 : "num_6",
					103 : "num_7",
					104 : "num_8",
					105 : "num_9",
					106 : "num_multiply",
					107 : "num_add",
					108 : "num_enter",
					109 : "num_subtract",
					110 : "num_decimal",
					111 : "num_divide" ,
					112 : "f1",
					113 : "f2",
					114 : "f3",
					115 : "f4",
					116 : "f5",
					117 : "f6",
					118 : "f7",
					119 : "f8",
					120 : "f9",
					121 : "f10",
					122 : "f11",
					123 : "f12",
					124 : "print",
					144 : "num",
					145 : "scroll",
					186 : ";",
					187 : "=",
					188 : ",",
					189 : "-",
					190 : ".",
					191 : "/",
					192 : "`",
					219 : "[",
					220 : "\\",
					221 : "]",
					222 : "\'",
					223 : "`",
					224 : "cmd",
					225 : "alt",
					// Opera weirdness
					57392   : "ctrl",
					63289   : "num",
					// Firefox weirdness
					59 : ";",
					61 : "=",
					173 : "-"
				};
				return _keycode_dictionary[keyCode] || null;
			};


			var tty = {

				raw:{
					lines:[[]],
					cursor:{
						line:0,
						column:0
					},
					dimensions:{
						width:120,
						height:50
					},
					inkwith:''
				},

				showOutput:function(){

						
					var source = []; for(var i=0; i<this.raw.lines.length; i++) source.push(this.raw.lines[i].slice());	//slice to copy array

					if(source[this.raw.cursor.line][this.raw.cursor.column]===undefined){source[this.raw.cursor.line][this.raw.cursor.column]={char:' '};}

					//console.log(source);

					//var out = '<span id="coords">('+this.raw.cursor.column+','+this.raw.cursor.line+')</span>'+"\n";
					var out = '';
					for(var i=0;i<source.length;i++){
						for(var j=0;j<source[i].length;j++){
							out += '<span class="';
							out += 'char ';
							out += 'char-'+source[i][j].char.charCodeAt(0)+' ';
							out += source[i][j].inkwith+' ';
							if(i===this.raw.cursor.line && j===this.raw.cursor.column) out += 'cursor ';
							out += '">'+source[i][j].char+'</span>';
						}
						out += '\n';
					}

					$('#terminal').html(out);
				},

				insertChar: function(c){

					if(this.raw.lines[this.raw.cursor.line]===undefined) this.raw.lines[this.raw.cursor.line]=[[]];
					this.raw.lines[this.raw.cursor.line][this.raw.cursor.column] = {char:c, inkwith:this.raw.inkwith};

				},

				erase: function(){
					this.raw.lines[this.raw.cursor.line] = this.raw.lines[this.raw.cursor.line].slice(0,this.raw.cursor.column);
				},

				//parse ansi one char at a time into array of lines, takes a multi character string of ansi
				addAnsi:function(ansi_blob){


					// for each character in blob
					for(var ansi_char_index=0; ansi_char_index<ansi_blob.length; ansi_char_index++){

						var ansi_char = ansi_blob.charAt(ansi_char_index);
						switch(ansi_char){
							
							default:
								//console.log('inserting "'+ansi_char+'" ('+ansi_char.charCodeAt(0)+') at ('+this.raw.cursor.column+','+this.raw.cursor.line+')');
								if(this.raw.cursor.column===this.raw.dimensions.width){
									this.raw.cursor.column=0;
									this.raw.cursor.line++;
									console.log(' >>> out-of-bounds, inserting at ('+this.raw.cursor.column+','+this.raw.cursor.line+') instead');
								}
								this.insertChar(ansi_char);
								this.raw.cursor.column++;
							break;

							case "\n":
								//console.log("newline n");
								this.raw.cursor.line++;
							break;
							case "\r":
								//console.log("carrage return");
								this.raw.cursor.column=0;
							break;
							
							case "":
								//console.log("backspace");
								this.raw.cursor.column--;
							break;
							
							case "":
								//console.log("bell");
								if(ansi_char_index==ansi_blob.length-1) beep();
							break;
							
							case "":

								var nextalphaindex = ansi_blob.substr(ansi_char_index).search(/[a-z@]/i);
								var code = ansi_blob.substr(ansi_char_index, nextalphaindex+1);
								
								if(ansi_blob.charAt(ansi_char_index+1)==="["){
									var arguments = ansi_blob.substr(ansi_char_index+2, nextalphaindex-2).split(';');
								}
								//console.log("ESC: "+code);

								switch(code[nextalphaindex]){

									//other
									default:
										var toinsert = '<span style="color:black; background:red;">UNKNOWN ESCAPE CODE {'+code+'}</span>';
										this.insertChar(toinsert);
									break;

									//shift line right?
									case "@":
										this.raw.lines[this.raw.cursor.line].unshift(' ');
										this.raw.lines[this.raw.cursor.line][0]=this.raw.lines[this.raw.cursor.line][1];
									break;

									//scroll up?
									case "M":
										this.raw.cursor.line--;
										//this.raw.cursor.column=0;
									break;

									// <ESC>[{ROW};{COLUMN}H
									// Cursor Home
									// Sets the cursor position where subsequent text will begin.
									// If no row/column parameters are provided (ie. <ESC>[H),
									// the cursor will move to the home position, at the upper left of the screen.
									case "H":
										var row = arguments[0];
										var column = arguments[1];
										this.cursor_position=0;
									break;

									case "h":
									console.log('UNKNOWN'+code);
									break;
									
									case "l":
									console.log('UNKNOWN'+code);
									break;


									// <ESC>[{COUNT}A
									// Cursor Up
									// Moves the cursor up by COUNT rows; the default count is 1.
									case "A":

									break;

									// <ESC>[{COUNT}C
									// Cursor Forward
									// Moves the cursor forward by COUNT columns; the default count is 1.
									case "C":
										this.raw.cursor.column++;
										//this.adjustCursor();
									break;

									// Delete
									// Set Key Definition
									// dont advance cursor by COUNT?
									//	this.insertAndClip('');
									//break;

									// Erase
									// <ESC>[J - Erase Down, Erases the screen from the current line down to the bottom of the screen. 
									// <ESC>[1J - Erase Up, Erases the screen from the current line up to the top of the screen. 
									// <ESC>[2J - Erase Screen, Erases the screen with the background colour and moves the cursor to home.
									case "J":
										this.raw.lines = [];
										this.raw.cursor.line=0;
										this.raw.cursor.column=0;
									break;

									// Erase Line
									// <ESC>[K - Erase End of Line, Erases from the current cursor position to the end of the current line.
									// <ESC>[1K - Erase Start of Line, Erases from the current cursor position to the start of the current line.
									// <ESC>[2K - Erase Line, Erases the entire current line. 
									case "P":
									case "K":
										var count = arguments[0];
										this.erase();
									break;

									//color codes
									case "m":
										for(var j=0;j<arguments.length;j++){
											if(parseInt(arguments[j])===0) this.raw.inkwith = '';
											else this.raw.inkwith+='char-style-'+parseInt(arguments[j])+' ';
										}
									break;

								}
								ansi_char_index+=nextalphaindex;	// move past current escape code

							break;


						} // end switch

					} // end for loop

					this.showOutput();

				}
			};
























			$(function() {
				
				$("#terminal").focus(function(){$("#terminal").addClass('active');});
				$("#terminal").focusout(function(){$("#terminal").removeClass('active');});
				$(".scrollcontainer").mCustomScrollbar({scrollInertia:0,scrollbarPosition:"outside"});
				$(window).focus(function(){$("#terminal").focus();});
				$("body").click(function(){$("#terminal").focus();});

				var socket = io();

				$('#newsession').click(function(e){
					var newname = Math.random().toString(36).replace(/[^a-z]+/g, '').substr(0, 5);
					window.location.assign("?s="+newname);
				});


				$(document).on('click', '#sessionlist #list button', function(e){
					window.location.assign($(e.target).attr('href'));
				});



				$("body").keydown(function(e) {
					e.preventDefault();
					var key = keyCodeToKey(e.which);
					if(key!="ctrl" && key!="shift" && key!="alt" && key!="cmd"){
						if(e.shiftKey) key = key.toUpperCase();
						if(e.ctrlKey) key = 'C-'+key;
						socket.emit('keypress', key);
					}
				});

				$('#destroy').click(function(e){
					if (confirm('Kill session '+window.location.search.replace('?s=','')+'?')) {
						socket.emit('destroy');
						$("#cursor").addClass('error');
					}
				});





/*


				$('#showraw').click(function(e){
					//tty.showOutput();

					$('#terminal span').each(function(i){
						$(this).delay(i*10).queue(function(){
							$(this).removeClass('spinAway').addClass('spinAway').dequeue();
						});
					});

				});
*/
/*
				$('#showhtml').click(function(e){
					$('#terminal').text(tty.html.lines.join('\n'));
				});

*/







				$('#paste').click(function(e){
					var cmd = prompt('paste command');
					if(cmd != null) {
						socket.emit('keypress',cmd);
					}
				});


				$('#insert').click(function(e){
					var options = [
						'sudo systemctl restart ratty',
						'systemctl status ratty -l',
						'cat /dev/null > ~/.bash_history && history -c && exit',
						'sudo init 6'
					];
					var optionsmsg = '';
					for(var i=0; i<options.length; i++) optionsmsg += i+': '+options[i]+'\n';
					var cmd = prompt('Insert command by number\n\n'+optionsmsg);
					socket.emit('keypress',options[cmd]);
					
				});




				$('#restart').click(function(e){
					socket.emit('keypress','sudo systemctl restart ratty');
				});

				$('#mainlog').click(function(e){
					socket.emit('keypress','systemctl status ratty -l');
				});

				$('#clearhistory').click(function(e){
					socket.emit('keypress','cat /dev/null > ~/.bash_history && history -c && exit');
				});






				/*

				$('#pop').click(function(e){
					window.open('/'+window.location.search,'pop','height=400,width=1000');
				});

				*/

				

					
				socket.on('sessionlist', function(list){
					var html = '';
					list.forEach(function(item) {
						var query = '?s=' + item;
						if(query === window.location.search){
							html += '<button class="current" href="'+query+'" title="Connect to session: '+item+'">'+item+'</button>';
						} else {
							html += '<button href="'+query+'" title="Connect to session: '+item+'">'+item+'</button>';
						}
					});
					$('#sessionlist #list').html(html);
				});

				socket.on('status', function(status){
					$('#status').text(status);
				});

				socket.on('disconnect', function(){
					$('#status').text('disconnected');
					$("#cursor").addClass('error');
				});

				socket.on('connect', function(){
					$("#cursor").removeClass('error');
				});



				socket.on('transcript', function(transcript){

					//console.log(transcript, typeof transcript, transcript.length, transcript.charCodeAt(0));
					tty.addAnsi(transcript);

					//var cursor_contains = tty.html.charAt(tty.cursor_position);
					//var out = [tty.html.slice(0, tty.cursor_position), '<span id="cursor" class="blink" debug-pos="'+tty.cursor_position+'">'+(cursor_contains?cursor_contains:'&nbsp;')+'</span>', tty.html.slice(tty.cursor_position+1)].join('');

					//$('#terminal').html(out);
					$("#terminal").scrollTop($("#terminal")[0].scrollHeight);
					$(".scrollcontainer").mCustomScrollbar("scrollTo","bottom");

				});
			});

		</script>

	</body>
</html>
